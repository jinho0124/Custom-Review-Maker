// ì• í”Œë¦¬ì¼€ì´ì…˜ ë°ì´í„° - ê¸°íšì„œì— ë§ê²Œ ë¸Œëœë“œëª… ë³€ê²½
const appData = {
    "categories": [
        {
            "name": "ë°°ë‹¬ì•±",
            "icon": "ğŸ›µ",
            "description": "ë°°ë‹¬ìŒì‹ ë¦¬ë·° ìŠ¤íƒ€ì¼",
            "brands": [
                {"name": "ë°°ë§Œ", "subtitle": "ë°°ë‹¬ì˜ ë§Œì¡± ë¦¬ë·° ì‘ì„±", "color": "#00D4AA", "style": "rounded"},
                {"name": "ì—¬ê¸°ìš”", "subtitle": "ì—¬ê¸°ìš” ë¦¬ë·° ì‘ì„±", "color": "#FF4757", "style": "angular"},
                {"name": "ííŒ¡ì´ì¸ ", "subtitle": "ííŒ¡ì´ì¸  ë¦¬ë·° ì‘ì„±", "color": "#3498DB", "style": "minimal"}
            ]
        },
        {
            "name": "ì‡¼í•‘ëª°",
            "icon": "ğŸ›ï¸",
            "description": "ì˜¨ë¼ì¸ì‡¼í•‘ ë¦¬ë·° ìŠ¤íƒ€ì¼",
            "brands": [
                {"name": "ííŒ¡", "subtitle": "ííŒ¡ ë¦¬ë·° ì‘ì„±", "color": "#3498DB", "style": "modern"},
                {"name": "ì¥ë§ˆì¼“", "subtitle": "ì¥ë§ˆì¼“ ë¦¬ë·° ì‘ì„±", "color": "#27AE60", "style": "price-focused"},
                {"name": "11ë²ˆê¸¸", "subtitle": "11ë²ˆê¸¸ ë¦¬ë·° ì‘ì„±", "color": "#E74C3C", "style": "premium"}
            ]
        },
        {
            "name": "ì¹´í˜",
            "icon": "â˜•",
            "description": "ì¹´í˜ ë¦¬ë·° ìŠ¤íƒ€ì¼",
            "brands": [
                {"name": "ìŠ¤íƒ€ë²„ì–µìŠ¤", "subtitle": "ìŠ¤íƒ€ë²„ì–µìŠ¤ ë¦¬ë·° ì‘ì„±", "color": "#00704A", "style": "global"},
                {"name": "ë¦¬ë””ì•¼", "subtitle": "ë¦¬ë””ì•¼ ë¦¬ë·° ì‘ì„±", "color": "#0052CC", "style": "local"},
                {"name": "íŠœì¸í”Œë ˆì´ìŠ¤", "subtitle": "íŠœì¸í”Œë ˆì´ìŠ¤ ë¦¬ë·° ì‘ì„±", "color": "#8B4513", "style": "cozy"}
            ]
        },
        {
            "name": "ì˜í™”ê´€",
            "icon": "ğŸ¬",
            "description": "ì˜í™” ë¦¬ë·° ìŠ¤íƒ€ì¼",
            "brands": [
                {"name": "CGB", "subtitle": "CGB ë¦¬ë·° ì‘ì„±", "color": "#E74C3C", "style": "dynamic"},
                {"name": "ë§¤ê°€ë°•ìŠ¤", "subtitle": "ë§¤ê°€ë°•ìŠ¤ ë¦¬ë·° ì‘ì„±", "color": "#6C5CE7", "style": "modern"},
                {"name": "ë£»ë°ì‹œë„¤ë§ˆ", "subtitle": "ë£»ë°ì‹œë„¤ë§ˆ ë¦¬ë·° ì‘ì„±", "color": "#F39C12", "style": "luxury"}
            ]
        }
    ],
    "emojis": {
        "ê°ì •": ["ğŸ˜Š", "ğŸ˜", "ğŸ¥°", "ğŸ˜‹", "ğŸ¤¤", "ğŸ˜", "ğŸ¤©", "ğŸ˜˜", "ğŸ˜‰", "ğŸ™‚", "ğŸ˜„", "ğŸ˜†", "ğŸ¤—", "ğŸ˜‡", "ğŸ¥º", "ğŸ˜®ğŸ’¨", "ğŸ« ", "ğŸ˜µğŸ’«"],
        "ìŒì‹": ["ğŸ”", "ğŸ•", "ğŸŸ", "ğŸŒ­", "ğŸ¥ª", "ğŸŒ®", "ğŸŒ¯", "ğŸ¥™", "ğŸ§†", "ğŸ¥˜", "ğŸ", "ğŸœ", "ğŸ²", "ğŸ¥—", "ğŸ±", "ğŸ£", "ğŸ¤", "ğŸ§‹"],
        "í™œë™": ["ğŸ‘", "ğŸ‘Œ", "âœŒï¸", "ğŸ¤", "ğŸ‘", "ğŸ™Œ", "ğŸ¤", "ğŸ’ª", "ğŸ‰", "ğŸŠ", "ğŸ¥³", "ğŸˆ", "ğŸ", "ğŸ†", "â­", "ğŸ’¯"],
        "ê¸°íƒ€": ["â¤ï¸", "ğŸ’–", "ğŸ’", "ğŸ”¥", "ğŸ’", "ğŸŒŸ", "âœ¨", "ğŸ¯", "ğŸ’«", "ğŸŒˆ", "ğŸ¦„", "ğŸ°", "ğŸ¶", "ğŸ±", "ğŸ¼", "ğŸ¦Š"]
    },
    "fonts": ["ê¸°ë³¸ì²´", "ë‘¥ê·¼ì²´", "ê³ ë”•ì²´", "ëª…ì¡°ì²´", "ì†ê¸€ì”¨ì²´"]
};

// ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ
let currentState = {
    screen: 'loading',
    selectedCategory: null,
    selectedBrand: null,
    reviewData: {
        memberName: '',
        memberGrade: 'ê³¨ë“œíšŒì›',
        storeName: '',
        rating: 5,
        title: '',
        content: '',
        emoji: 'ğŸ˜Š',
        font: 'ê¸°ë³¸ì²´',
        photos: [],
        bestReview: false,
        reviewDate: new Date().toISOString().split('T')[0]
    },
    cart: []
};

// DOM ìš”ì†Œë“¤ì„ ì €ì¥í•  ê°ì²´
const DOM = {};
let loadingStarInterval; // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¸í„°ë²Œ ID

// ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing app...');
    initializeApp();
});

function initializeApp() {
    // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ë° ì €ì¥
    DOM.loadingScreen = document.getElementById('loading-screen');
    DOM.mainScreen = document.getElementById('main-screen');
    DOM.brandScreen = document.getElementById('brand-screen');
    DOM.reviewScreen = document.getElementById('review-screen');
    DOM.cartScreen = document.getElementById('cart-screen');
    DOM.cartCountElements = document.querySelectorAll('#cart-count');
    DOM.reviewPreview = document.getElementById('review-preview');
    DOM.photoPreviewContainer = document.getElementById('photo-preview');
    DOM.ratingStars = document.querySelectorAll('.rating-star');
    DOM.emojiContainer = document.getElementById('emoji-container');
    DOM.emojiTabs = document.querySelectorAll('.emoji-tab');
    DOM.categoryCards = document.querySelectorAll('.category-card');
    DOM.brandsContainer = document.getElementById('brands-container');
    DOM.photoUpload = document.getElementById('photo-upload');
    DOM.cartSearch = document.getElementById('cart-search');
    DOM.saveModal = document.getElementById('save-modal');
    DOM.saveNameInput = document.getElementById('save-name');

    // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    animateLoadingStars();

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupEventListeners();

    // ì €ì¥ëœ ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ
    loadCartFromStorage();

    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
    const reviewDateInput = document.getElementById('review-date');
    if (reviewDateInput) {
        reviewDateInput.value = currentState.reviewData.reviewDate;
    }
    
    // ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
    setTimeout(() => {
        clearInterval(loadingStarInterval); // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        showScreen('main');
    }, 3000);
}

function animateLoadingStars() {
    const stars = document.querySelectorAll('.loading-screen .star');
    let currentStar = 0;
    
    loadingStarInterval = setInterval(() => {
        // ëª¨ë“  ë³„ì„ ì´ˆê¸°í™”
        stars.forEach(star => star.classList.remove('filled'));
        
        // í˜„ì¬ê¹Œì§€ì˜ ë³„ë“¤ì„ ì±„ì›€
        for (let i = 0; i <= currentStar; i++) {
            if (stars[i]) {
                stars[i].classList.add('filled');
            }
        }
        
        currentStar++;
        
        // 5ê°œ ëª¨ë‘ ì±„ì› ìœ¼ë©´ ë‹¤ì‹œ ì²˜ìŒë¶€í„°
        if (currentStar >= stars.length) {
            currentStar = 0;
        }
    }, 500);
}

function setupEventListeners() {
    // ì¹´í…Œê³ ë¦¬ ì„ íƒ
    DOM.categoryCards.forEach(card => {
        card.addEventListener('click', function() {
            const category = this.dataset.category;
            selectCategory(category);
        });
    });
    
    // ì‚¬ì§„ ì—…ë¡œë“œ
    if (DOM.photoUpload) {
        DOM.photoUpload.addEventListener('change', handlePhotoUpload);
    }
    
    // í¼ ì…ë ¥
    setupFormListeners();
    
    // ë³„ì 
    setupRatingListeners();
    
    // ì´ëª¨í‹°ì½˜
    setupEmojiListeners();
    
    // ì¥ë°”êµ¬ë‹ˆ ê²€ìƒ‰
    if (DOM.cartSearch) {
        DOM.cartSearch.addEventListener('input', filterCartItems);
    }

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
    const closeSaveModalBtn = document.querySelector('.close-modal-btn');
    if (closeSaveModalBtn) {
        closeSaveModalBtn.addEventListener('click', hideSaveModal);
    }

    // ëª¨ë‹¬ ì €ì¥ í™•ì¸ ë²„íŠ¼
    const confirmSaveBtn = document.getElementById('confirm-save-btn');
    if (confirmSaveBtn) {
        confirmSaveBtn.addEventListener('click', confirmSave);
    }
}

function setupFormListeners() {
    const inputs = [
        'member-name', 'store-name', 'review-title', 'review-content', 
        'font-select', 'member-grade', 'best-review', 'review-date'
    ];
    
    inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateReviewData);
            element.addEventListener('change', updateReviewData); // select, checkbox, date ë“±ì˜ ë³€ê²½ ê°ì§€
        }
    });
}

function setupRatingListeners() {
    DOM.ratingStars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            setRating(rating);
        });
    });
}

function setupEmojiListeners() {
    // ì´ëª¨í‹°ì½˜ íƒ­ ì„¤ì •
    DOM.emojiTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const category = this.dataset.category;
            showEmojiCategory(category);
            
            // íƒ­ í™œì„±í™”
            DOM.emojiTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // ê¸°ë³¸ ê°ì • ì´ëª¨í‹°ì½˜ í‘œì‹œ (ì´ˆê¸°í™” ì‹œ)
    showEmojiCategory('ê°ì •');
    // ê°ì • íƒ­ì„ activeë¡œ ì„¤ì •
    const emotionTab = document.querySelector('.emoji-tab[data-category="ê°ì •"]');
    if(emotionTab) emotionTab.classList.add('active');
}

function showScreen(screenName) {
    // ëª¨ë“  í™”ë©´ ìˆ¨ê¸°ê¸°
    [DOM.loadingScreen, DOM.mainScreen, DOM.brandScreen, DOM.reviewScreen, DOM.cartScreen].forEach(screen => {
        if (screen) {
            screen.classList.add('hidden');
        }
    });
    
    // ì„ íƒëœ í™”ë©´ í‘œì‹œ
    const targetScreen = DOM[`${screenName}Screen`]; // ë™ì ìœ¼ë¡œ DOM ê°ì²´ì—ì„œ ê°€ì ¸ì˜´
    if (targetScreen) {
        targetScreen.classList.remove('hidden');
    }
    
    currentState.screen = screenName;
}

function selectCategory(categoryName) {
    currentState.selectedCategory = categoryName;
    
    // ì¹´í…Œê³ ë¦¬ ì œëª© ì—…ë°ì´íŠ¸
    const categoryTitle = document.getElementById('category-title');
    if (categoryTitle) {
        categoryTitle.textContent = categoryName;
    }
    
    // ë¸Œëœë“œ ì¹´ë“œ ìƒì„±
    generateBrandCards(categoryName);
    
    // ë¸Œëœë“œ í™”ë©´ í‘œì‹œ
    showScreen('brand');
}

function generateBrandCards(categoryName) {
    const category = appData.categories.find(cat => cat.name === categoryName);
    
    if (!DOM.brandsContainer || !category) return;
    
    DOM.brandsContainer.innerHTML = '';
    
    category.brands.forEach(brand => {
        const brandCard = document.createElement('div');
        brandCard.className = 'brand-card';
        brandCard.style.borderColor = brand.color;
        brandCard.addEventListener('click', () => selectBrand(brand));
        
        brandCard.innerHTML = `
            <h4 style="color: ${brand.color};">${brand.name}</h4>
            <p>${brand.subtitle}</p>
            <small style="color: ${brand.color};">${brand.style} ìŠ¤íƒ€ì¼</small>
        `;
        
        DOM.brandsContainer.appendChild(brandCard);
    });
}

function selectBrand(brand) {
    currentState.selectedBrand = brand;
    
    // ë¸Œëœë“œ ì œëª© ì—…ë°ì´íŠ¸
    const brandTitle = document.getElementById('brand-title');
    if (brandTitle) {
        brandTitle.textContent = brand.subtitle;
    }
    
    // ë¦¬ë·° ë°ì´í„° ì´ˆê¸°í™”
    resetReviewData();
    
    // ë¦¬ë·° í™”ë©´ í‘œì‹œ
    showScreen('review');
    
    // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updatePreview();
}

function resetReviewData() {
    currentState.reviewData = {
        memberName: '',
        memberGrade: 'ê³¨ë“œíšŒì›',
        storeName: '',
        rating: 5,
        title: '',
        content: '',
        emoji: 'ğŸ˜Š',
        font: 'ê¸°ë³¸ì²´',
        photos: [],
        bestReview: false,
        reviewDate: new Date().toISOString().split('T')[0]
    };
    
    // í¼ ì…ë ¥ ì´ˆê¸°í™”
    const inputs = [
        'member-name', 'store-name', 'review-title', 'review-content'
    ];
    
    inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });
    
    document.getElementById('member-grade').value = 'ê³¨ë“œíšŒì›';
    document.getElementById('font-select').value = 'ê¸°ë³¸ì²´';
    document.getElementById('best-review').checked = false;
    document.getElementById('review-date').value = currentState.reviewData.reviewDate;
    
    // ë³„ì  ì´ˆê¸°í™”
    setRating(5);
    
    // ì´ëª¨í‹°ì½˜ ì´ˆê¸°í™”
    selectEmoji('ğŸ˜Š');
    
    // ì‚¬ì§„ ì´ˆê¸°í™”
    DOM.photoPreviewContainer.innerHTML = '';
}

function handlePhotoUpload(event) {
    const files = Array.from(event.target.files);
    
    files.forEach(file => {
        if (currentState.reviewData.photos.length >= 5) {
            showToast('ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            currentState.reviewData.photos.push(e.target.result);
            updatePhotoPreview();
            updatePreview();
        };
        reader.readAsDataURL(file);
    });
}

function updatePhotoPreview() {
    DOM.photoPreviewContainer.innerHTML = '';
    
    currentState.reviewData.photos.forEach((photo, index) => {
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-preview-item';
        
        photoItem.innerHTML = `
            <img src="${photo}" alt="ì‚¬ì§„ ${index + 1}">
            <button class="photo-remove-btn" onclick="removePhoto(${index})">Ã—</button>
        `;
        
        DOM.photoPreviewContainer.appendChild(photoItem);
    });
}

function removePhoto(index) {
    currentState.reviewData.photos.splice(index, 1);
    updatePhotoPreview();
    updatePreview();
}

function setRating(rating) {
    currentState.reviewData.rating = rating;
    
    // ì‹œê°ì  ë³„ì  ì—…ë°ì´íŠ¸
    DOM.ratingStars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
    
    updatePreview();
}

function showEmojiCategory(category) {
    const emojis = appData.emojis[category] || [];
    
    DOM.emojiContainer.innerHTML = '';
    
    emojis.forEach(emoji => {
        const emojiOption = document.createElement('span');
        emojiOption.className = 'emoji-option';
        emojiOption.textContent = emoji;
        emojiOption.dataset.emoji = emoji;
        emojiOption.addEventListener('click', () => selectEmoji(emoji));
        
        DOM.emojiContainer.appendChild(emojiOption);
    });
}

function selectEmoji(emoji) {
    currentState.reviewData.emoji = emoji;
    
    // ì‹œê°ì  ì„ íƒ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.emoji-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    const selectedEmoji = document.querySelector(`[data-emoji="${emoji}"]`);
    if (selectedEmoji) {
        selectedEmoji.classList.add('selected');
    }
    
    updatePreview();
}

function updateReviewData() {
    // í¼ ë°ì´í„° ìˆ˜ì§‘
    currentState.reviewData.memberName = document.getElementById('member-name').value;
    currentState.reviewData.memberGrade = document.getElementById('member-grade').value;
    currentState.reviewData.storeName = document.getElementById('store-name').value;
    currentState.reviewData.title = document.getElementById('review-title').value;
    currentState.reviewData.content = document.getElementById('review-content').value;
    currentState.reviewData.font = document.getElementById('font-select').value;
    currentState.reviewData.bestReview = document.getElementById('best-review').checked;
    currentState.reviewData.reviewDate = document.getElementById('review-date').value;
    
    updatePreview();
}

function updatePreview() {
    const brand = currentState.selectedBrand;
    const data = currentState.reviewData;
    
    if (!brand || !DOM.reviewPreview) return;
    
    let previewHTML = '';
    
    // ë¸Œëœë“œ ì´ë¦„ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ í˜¸ì¶œ
    // ì˜ˆ: "ë°°ë§Œ" -> "generateBaemanPreview"
    //     "ì—¬ê¸°ìš”" -> "generateYogiyoPreview"
    //     "ííŒ¡ì´ì¸ " -> "generateCoupangeatsPreview"
    const functionName = `generate${brand.name.replace(/(\w)/, (match) => match.toUpperCase()).replace(/(\S)(\S*)/g, (g0, g1, g2) => g1.toUpperCase() + g2.toLowerCase()).replace(/ /g, '')}Preview`;

    if (typeof window[functionName] === 'function') {
        previewHTML = window[functionName](data);
    } else {
        previewHTML = generateDefaultPreview(data);
    }
    
    DOM.reviewPreview.innerHTML = previewHTML;
    applyFontClass(DOM.reviewPreview, data.font);
}

// ê° ë¸Œëœë“œë³„ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼)
function generateBaemanPreview(data) { // 'ë°°ë§Œ'ìœ¼ë¡œ í•¨ìˆ˜ëª… ë³€ê²½
    const stars = 'â˜…'.repeat(data.rating) + 'â˜†'.repeat(5 - data.rating);
    const photosHTML = data.photos.map(photo => 
        `<img src="${photo}" class="photo-preview" alt="ë¦¬ë·° ì‚¬ì§„">`
    ).join('');
    
    const bestBadge = data.bestReview ? 
        `<div class="best-badge">ì¶”ì²œ ë¦¬ë·°</div>` : '';
    
    const memberGrade = data.memberGrade ? 
        `<span class="user-grade">${data.memberGrade}</span>` : '';
    
    return `
        <div class="preview-baemin">
            <div class="brand-subtitle">${currentState.selectedBrand.subtitle}</div>
            ${bestBadge}
            
            <div class="user-profile">
                <div class="user-avatar">${(data.memberName || 'ì‚¬ìš©ì')[0]}</div>
                <div class="user-info">
                    <div class="username">${data.memberName || 'ì‚¬ìš©ìëª…'} ${memberGrade}</div>
                    <div class="user-stats">ë¦¬ë·° 12 â€¢ í‰ê· ë³„ì  4.8</div>
                </div>
            </div>
            
            <div class="store-name">${data.storeName || 'ê°€ê²Œëª…'}</div>
            <div class="rating">${stars} ${data.reviewDate}</div>
            
            ${photosHTML}
            
            <div class="review-text">
                <strong>${data.title || 'ë¦¬ë·° ì œëª©'}</strong><br>
                ${data.content || 'ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'} ${data.emoji}
            </div>
            
            <div style="margin-top: 12px;">
                <button class="help-btn">ë§›ìµœí‚¹ ì™• ğŸ‘</button>
                <button class="help-btn">ë³¸ëª¨ì ë¡œì œ ë–¡ë³¶ì´ ğŸ‘</button>
            </div>
            
            <div style="margin-top: 12px; padding: 8px; background: #e8f5e8; border-radius: 8px; font-size: 12px;">
                ğŸ’¬ ì‚¬ì¥ë‹˜ ëŒ“ê¸€: ë§›ìˆê²Œ ë“œì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!
            </div>
        </div>
    `;
}

function generateYogiyoPreview(data) {
    const stars = 'â˜…'.repeat(data.rating) + 'â˜†'.repeat(5 - data.rating);
    const photosHTML = data.photos.map(photo => 
        `<img src="${photo}" class="photo-preview" alt="ë¦¬ë·° ì‚¬ì§„">`
    ).join('');
    
    const bestBadge = data.bestReview ? 
        `<div class="best-badge">BEST</div>` : '';
    
    const memberGrade = data.memberGrade ? 
        `<span class="user-grade">${data.memberGrade}</span>` : '';
    
    return `
        <div class="preview-yogiyo">
            <div class="brand-subtitle">${currentState.selectedBrand.subtitle}</div>
            ${bestBadge}
            
            <div class="user-profile">
                <div class="username">${data.memberName || 'ì‚¬ìš©ìëª…'} ${memberGrade}</div>
                <div class="user-stats">ë¦¬ë·° 290 â€¢ í‰ê· ë³„ì  4.7</div>
            </div>
            
            <div class="store-name">${data.storeName || 'ê°€ê²Œëª…'}</div>
            <div class="rating-detailed">
                <span>ë§›: ${stars}</span>
                <span>ì–‘: ${stars}</span>
                <span>ë°°ë‹¬: ${stars}</span>
            </div>
            
            ${photosHTML}
            
            <div class="review-text">
                <strong>${data.title || 'ë¦¬ë·° ì œëª©'}</strong><br>
                ${data.content || 'ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'} ${data.emoji}
            </div>
            
            <div style="margin-top: 12px; font-size: 12px; color: #666;">
                ${data.reviewDate} â€¢ ì•Œëœ°ë°°ë‹¬
            </div>
            
            <div class="actions" style="margin-top: 12px;">
                <button class="btn-recommend">ì¶”ì²œí•´ìš”</button>
                <button class="btn-block">ì°¨ë‹¨</button>
            </div>
        </div>
    `;
}

function generateCoupangeatsPreview(data) { // 'ííŒ¡ì´ì¸ 'ë¡œ í•¨ìˆ˜ëª… ë³€ê²½
    const stars = 'â˜…'.repeat(data.rating) + 'â˜†'.repeat(5 - data.rating);
    const photosHTML = data.photos.map(photo => 
        `<img src="${photo}" class="photo-preview" alt="ë¦¬ë·° ì‚¬ì§„">`
    ).join('');
    
    const bestBadge = data.bestReview ? 
        `<div class="best-badge">ë­í‚¹ ë¦¬ë·°ì–´</div>` : '';
    
    const memberGrade = data.memberGrade ? 
        `<span class="user-grade">${data.memberGrade}</span>` : '';
    
    return `
        <div class="preview-coupangeats">
            <div class="brand-subtitle">${currentState.selectedBrand.subtitle}</div>
            ${bestBadge}
            
            <div class="user-profile">
                <div class="username">${data.memberName || 'one'} ${memberGrade}</div>
                <div class="user-stats">ë¦¬ë·° 62 â€¢ í‰ê· ë³„ì  4.9</div>
            </div>
            
            <div class="store-name">${data.storeName || 'ê°€ê²Œëª…'}</div>
            <div class="rating">${stars} ${data.reviewDate}</div>
            
            ${photosHTML}
            
            <div class="review-text">
                <strong>${data.title || 'ë¦¬ë·° ì œëª©'}</strong><br>
                ${data.content || 'ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'} ${data.emoji}
            </div>
            
            <div style="margin-top: 12px;">
                <button class="help-btn" style="background: #3498DB;">ë¿Œë§í´</button>
            </div>
        </div>
    `;
}
// ííŒ¡, ì¥ë§ˆì¼“, 11ë²ˆê¸¸, ìŠ¤íƒ€ë²„ì–µìŠ¤, ë¦¬ë””ì•¼, íŠœì¸í”Œë ˆì´ìŠ¤, CGB, ë§¤ê°€ë°•ìŠ¤, ë£»ë°ì‹œë„¤ë§ˆ ë“±
// ë‹¤ë¥¸ ë¸Œëœë“œì— ëŒ€í•œ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ë„ ìœ„ì™€ ê°™ì€ ê·œì¹™ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
// ì˜ˆ: generateCoupangPreview, generateGmarketPreview ë“±

function generateDefaultPreview(data) {
    const stars = 'â˜…'.repeat(data.rating) + 'â˜†'.repeat(5 - data.rating);
    const photosHTML = data.photos.map(photo => 
        `<img src="${photo}" class="photo-preview" alt="ë¦¬ë·° ì‚¬ì§„">`
    ).join('');
    
    return `
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 16px;">
            ${photosHTML}
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${data.storeName || 'ì—…ì²´ëª…'}</div>
            <div style="color: #ffd700; margin-bottom: 12px;">${stars}</div>
            <div>
                <strong>${data.title || 'ë¦¬ë·° ì œëª©'}</strong><br>
                ${data.content || 'ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'} ${data.emoji}
            </div>
            <div style="margin-top: 12px; font-size: 12px; color: #666;">
                ${data.memberName || 'ì‚¬ìš©ì'} | ${data.reviewDate}
            </div>
        </div>
    `;
}

function applyFontClass(element, fontType) {
    element.classList.remove('font-basic', 'font-round', 'font-gothic', 'font-myeongjo', 'font-handwriting');
    
    switch(fontType) {
        case 'ë‘¥ê·¼ì²´':
            element.classList.add('font-round');
            break;
        case 'ê³ ë”•ì²´':
            element.classList.add('font-gothic');
            break;
        case 'ëª…ì¡°ì²´':
            element.classList.add('font-myeongjo');
            break;
        case 'ì†ê¸€ì”¨ì²´':
            element.classList.add('font-handwriting');
            break;
        default:
            element.classList.add('font-basic');
    }
}

// ì¥ë°”êµ¬ë‹ˆ ê´€ë ¨ í•¨ìˆ˜ë“¤
function saveToCart() {
    const reviewData = { ...currentState.reviewData };
    reviewData.brandName = currentState.selectedBrand.name;
    reviewData.brandSubtitle = currentState.selectedBrand.subtitle;
    reviewData.savedAt = new Date().toISOString();
    reviewData.id = Date.now();
    
    currentState.cart.push(reviewData);
    saveCartToStorage();
    updateCartCount();
    
    showToast('ë¦¬ë·°ê°€ ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

function showCart() {
    renderCartItems();
    showScreen('cart');
}

function hideCart() {
    goBack();
}

function renderCartItems() {
    const container = document.getElementById('cart-items');
    
    if (!container) return; // ìš”ì†Œê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„
    
    if (currentState.cart.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">ì„ì‹œì €ì¥ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    container.innerHTML = '';
    
    currentState.cart.forEach((item, index) => {
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        
        const savedDate = new Date(item.savedAt).toLocaleString();
        const preview = `${item.brandName} - ${item.storeName || 'ì—…ì²´ëª…'} - ${item.title || 'ì œëª© ì—†ìŒ'}`;
        
        cartItem.innerHTML = `
            <div class="cart-item-header">
                <div class="cart-item-title">${item.brandSubtitle}</div>
                <div class="cart-item-date">${savedDate}</div>
            </div>
            <div class="cart-item-preview">${preview}</div>
            <div class="cart-item-actions">
                <button class="btn btn--primary btn--sm" onclick="loadFromCart(${index})">ì´ì–´ì“°ê¸°</button>
                <button class="btn btn--secondary btn--sm" onclick="removeFromCart(${index})">ì‚­ì œ</button>
            </div>
        `;
        
        container.appendChild(cartItem);
    });
}

function loadFromCart(index) {
    const item = currentState.cart[index];
    
    // ë¸Œëœë“œ ì„ íƒ
    const category = appData.categories.find(cat => 
        cat.brands.some(brand => brand.name === item.brandName)
    );
    const brand = category.brands.find(brand => brand.name === item.brandName);
    
    currentState.selectedCategory = category.name;
    currentState.selectedBrand = brand;
    currentState.reviewData = { ...item };
    
    // í¼ ë°ì´í„° ë³µì›
    document.getElementById('member-name').value = item.memberName || '';
    document.getElementById('member-grade').value = item.memberGrade || 'ê³¨ë“œíšŒì›';
    document.getElementById('store-name').value = item.storeName || '';
    document.getElementById('review-title').value = item.title || '';
    document.getElementById('review-content').value = item.content || '';
    document.getElementById('font-select').value = item.font || 'ê¸°ë³¸ì²´';
    document.getElementById('best-review').checked = item.bestReview || false;
    document.getElementById('review-date').value = item.reviewDate || new Date().toISOString().split('T')[0];
    
    setRating(item.rating || 5);
    selectEmoji(item.emoji || 'ğŸ˜Š');
    updatePhotoPreview();
    
    // ë¸Œëœë“œ ì œëª© ì—…ë°ì´íŠ¸
    const brandTitle = document.getElementById('brand-title');
    if (brandTitle) {
        brandTitle.textContent = brand.subtitle;
    }
    
    showScreen('review');
    updatePreview();
    showToast('ì„ì‹œì €ì¥ëœ ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
}

function removeFromCart(index) {
    if (confirm('ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        currentState.cart.splice(index, 1);
        saveCartToStorage();
        updateCartCount();
        renderCartItems();
        showToast('ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
}

function clearCart() {
    if (confirm('ëª¨ë“  ì„ì‹œì €ì¥ëœ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        currentState.cart = [];
        saveCartToStorage();
        updateCartCount();
        renderCartItems();
        showToast('ëª¨ë“  ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
}

function filterCartItems() {
    const searchTerm = DOM.cartSearch.value.toLowerCase();
    const items = document.querySelectorAll('.cart-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function saveCartToStorage() {
    localStorage.setItem('customReviewCart', JSON.stringify(currentState.cart));
}

function loadCartFromStorage() {
    const saved = localStorage.getItem('customReviewCart');
    if (saved) {
        currentState.cart = JSON.parse(saved);
        updateCartCount();
    }
}

function updateCartCount() {
    DOM.cartCountElements.forEach(element => {
        element.textContent = currentState.cart.length;
    });
}

// ì €ì¥ ê´€ë ¨ í•¨ìˆ˜ë“¤
function saveReview() {
    const saveName = generateDefaultSaveName();
    if (DOM.saveNameInput) {
        DOM.saveNameInput.value = saveName;
    }
    showSaveModal();
}

function generateDefaultSaveName() {
    const brandName = currentState.selectedBrand ? currentState.selectedBrand.name : 'ë¦¬ë·°';
    const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
    return `${brandName}_ë¦¬ë·°_${date}`;
}

function showSaveModal() {
    if (DOM.saveModal) {
        DOM.saveModal.classList.remove('hidden');
    }
}

function hideSaveModal() {
    if (DOM.saveModal) {
        DOM.saveModal.classList.add('hidden');
    }
}

function confirmSave() {
    const saveName = DOM.saveNameInput ? DOM.saveNameInput.value.trim() : '';
    
    if (!saveName) {
        showToast('ì €ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (typeof html2canvas === 'undefined') {
        showToast('ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.');
        console.error('html2canvas is not loaded. Please add <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> to your HTML file.');
        hideSaveModal();
        return;
    }

    // ì‹¤ì œ ì €ì¥ ë¡œì§ (html2canvasë¥¼ ì‚¬ìš©í•˜ì—¬ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì´ë¯¸ì§€ë¡œ ë‹¤ìš´ë¡œë“œ)
    downloadReviewImage(saveName);
    hideSaveModal();
}

// **html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ì„ ê°€ì •**
function downloadReviewImage(filename) {
    const preview = DOM.reviewPreview; // ë¯¸ë¦¬ë³´ê¸°ê°€ ë“¤ì–´ìˆëŠ” ìš”ì†Œ

    // ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œê°€ ì—†ê±°ë‚˜, html2canvasê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì¢…ë£Œ
    if (!preview || typeof html2canvas === 'undefined') {
        showToast('ì´ë¯¸ì§€ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
    }

    html2canvas(preview, {
        useCORS: true, // í¬ë¡œìŠ¤ ì˜¤ë¦¬ì§„ ì´ë¯¸ì§€ ë¡œë“œë¥¼ í—ˆìš© (ì‚¬ì§„ ì—…ë¡œë“œ ì‹œ í•„ìš”)
        scale: 2 // í•´ìƒë„ ë†’ì´ê¸°
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = `${filename}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('ë¦¬ë·° ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }).catch(error => {
        console.error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨:', error);
        showToast('ë¦¬ë·° ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// Toast ë©”ì‹œì§€ (CSS í•„ìš”)
function showToast(message) {
    let toast = document.getElementById('toast-message');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-message';
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        `;
        document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.style.opacity = 1;
    setTimeout(() => {
        toast.style.opacity = 0;
    }, 3000); // 3ì´ˆ í›„ ì‚¬ë¼ì§
}

// ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
function goBack() {
    switch(currentState.screen) {
        case 'brand':
            showScreen('main');
            break;
        case 'review':
            showScreen('brand');
            break;
        case 'cart':
            showScreen(currentState.selectedBrand ? 'review' : 'main');
            break;
        default:
            showScreen('main');
    }
}
